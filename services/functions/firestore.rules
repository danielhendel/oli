rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // DEFAULT DENY (GLOBAL SAFETY NET)
    //
    // Any collection or document not explicitly allowed below
    // is denied by default. This protects against:
    // - New collections accidentally becoming writable
    // - Typos or schema drift creating security holes
    // ============================================================
    match /{document=**} {
      allow read, write: if false;
    }

    // ============================================================
    // USERS (OWNER-SCOPED ROOT)
    // ============================================================
    match /users/{userId} {

      // ----------------------------------------------------------
      // USER ROOT DOCUMENT (profile / settings)
      //
      // ❗ CRITICAL INVARIANT:
      // Client-side deletion is DISALLOWED until backend-enforced
      // cascading deletion + audit guarantees exist.
      // ----------------------------------------------------------
      allow read, create, update: if request.auth != null
                                  && request.auth.uid == userId;
      allow delete: if false;

      // ----------------------------------------------------------
      // SOURCES (user-owned configuration)
      //
      // Examples:
      // - Apple Health source
      // - Manual logging source
      // ----------------------------------------------------------
      match /sources/{sourceId} {
        allow read, create, update, delete: if request.auth != null
                                            && request.auth.uid == userId;
      }

      // ----------------------------------------------------------
      // RAW EVENTS (INGESTION BOUNDARY)
      //
      // ❗ CRITICAL INVARIANT:
      // - Clients may READ their raw events for transparency/debug
      // - Clients may NEVER write raw events
      // - All writes go through API / backend ingestion only
      // ----------------------------------------------------------
      match /rawEvents/{rawEventId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // CANONICAL EVENTS (NORMALIZED TRUTH)
      //
      // ❗ Backend-only writes (Admin SDK bypasses rules)
      // ----------------------------------------------------------
      match /events/{eventId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // DAILY FACTS (DERIVED TRUTH)
      //
      // ❗ Backend-only writes
      // ----------------------------------------------------------
      match /dailyFacts/{dateId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // INSIGHTS (DERIVED INTERPRETATIONS)
      //
      // ❗ Backend-only writes
      // ----------------------------------------------------------
      match /insights/{insightId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // INTELLIGENCE CONTEXT (DAILY SUMMARY STATE)
      //
      // ❗ Backend-only writes
      // ----------------------------------------------------------
      match /intelligenceContext/{dateId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // FAILURES (IMMUTABLE FAILURE MEMORY)
      //
      // ❗ Backend-only writes (append-only)
      // ----------------------------------------------------------
      match /failures/{failureId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }
    }
  }
}
