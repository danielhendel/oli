rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // âœ… Default deny: future-proof against new collections/subcollections.
    match /{document=**} {
      allow read, write: if false;
    }

    // ------------------------------------------------------------
    // USERS (owner-scoped)
    // ------------------------------------------------------------
    match /users/{userId} {
      // The user doc itself (profile/settings).
      allow read, create, update, delete: if request.auth != null && request.auth.uid == userId;

      // ----------------------------------------------------------
      // SOURCES (user-owned config)
      // ----------------------------------------------------------
      match /sources/{sourceId} {
        allow read, create, update, delete: if request.auth != null && request.auth.uid == userId;
      }

      // ----------------------------------------------------------
      // RAW EVENTS (INGESTION BOUNDARY)
      //
      // ðŸ”’ Backend-only writes (Cloud Run / Functions Admin SDK).
      // Clients may read their own raw events (debug/visibility),
      // but cannot create/update/delete.
      // ----------------------------------------------------------
      match /rawEvents/{rawEventId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // CANONICAL EVENTS / DAILY FACTS / INSIGHTS / INTELLIGENCE
      //
      // ðŸ”’ Backend-only writes (Admin SDK bypasses rules).
      // Clients can read their own derived data.
      // ----------------------------------------------------------
      match /events/{eventId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      match /dailyFacts/{dateId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      match /insights/{insightId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      match /intelligenceContext/{dateId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow create, update, delete: if false;
      }
    }
  }
}
