// services/functions/firestore.rules

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      match /sources/{sourceId} {
        allow read, write: if request.auth.uid == userId;
      }

      // ------------------------------------------
      // RAW EVENTS (INGESTION BOUNDARY)
      //
      // ðŸ”’ IMPORTANT:
      // RawEvents MUST ONLY be written by backend services (Cloud Run API / Functions Admin SDK),
      // never by the client. This prevents bypassing validation, idempotency, auditing, and
      // future ingestion controls.
      //
      // Clients may read their own RawEvents for debugging/visibility, but cannot write.
      // ------------------------------------------
      match /rawEvents/{rawEventId} {
        allow read: if request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // Canonical events: backend-only writes
      match /events/{eventId} {
        allow read: if request.auth.uid == userId;
        allow write: if request.auth.token.admin == true;
      }

      // Daily facts: backend-only writes
      match /dailyFacts/{dateId} {
        allow read: if request.auth.uid == userId;
        allow write: if request.auth.token.admin == true;
      }

      // Insights: backend-only writes
      match /insights/{insightId} {
        allow read: if request.auth.uid == userId;
        allow write: if request.auth.token.admin == true;
      }

      // Intelligence context: backend-only writes
      match /intelligenceContext/{dateId} {
        allow read: if request.auth.uid == userId;
        allow write: if request.auth.token.admin == true;
      }
    }
  }
}
