rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================
    // DEFAULT DENY (GLOBAL SAFETY NET)
    //
    // Any collection or document not explicitly allowed below
    // is denied by default. This protects against:
    // - New collections accidentally becoming writable
    // - Typos or schema drift creating security holes
    // ============================================================
    match /{document=**} {
      allow read, write: if false;
    }

    // ============================================================
    // USERS (OWNER-SCOPED ROOT)
    // ============================================================
    match /users/{userId} {

      // ----------------------------------------------------------
      // USER ROOT DOCUMENT (profile / settings)
      //
      // üîí Sprint 4 ‚Äî Client Firestore Lockdown
      //
      // ‚ùó CONSTITUTIONAL INVARIANT:
      // Clients may READ their own data, but may NEVER WRITE.
      // All writes go through backend APIs only.
      // ----------------------------------------------------------
      allow read: if request.auth != null
                  && request.auth.uid == userId;
      allow create, update, delete: if false;

      // ----------------------------------------------------------
      // SOURCES (user-owned configuration)
      //
      // üîí Sprint 4 ‚Äî Client Firestore Lockdown
      //
      // Examples:
      // - Apple Health source
      // - Manual logging source
      //
      // ‚ùó Backend-only writes
      // ----------------------------------------------------------
      match /sources/{sourceId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // RAW EVENTS (INGESTION BOUNDARY)
      //
      // ‚ùó CRITICAL INVARIANT:
      // - Clients may READ their raw events for transparency/debug
      // - Clients may NEVER write raw events
      // - All writes go through API / backend ingestion only
      // ----------------------------------------------------------
      match /rawEvents/{rawEventId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // CANONICAL EVENTS (NORMALIZED TRUTH)
      //
      // ‚ùó Backend-only writes (Admin SDK bypasses rules)
      // ----------------------------------------------------------
      match /events/{eventId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // DAILY FACTS (DERIVED TRUTH)
      //
      // ‚ùó Backend-only writes
      // ----------------------------------------------------------
      match /dailyFacts/{dateId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // INSIGHTS (DERIVED INTERPRETATIONS)
      //
      // ‚ùó Backend-only writes
      // ----------------------------------------------------------
      match /insights/{insightId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // INTELLIGENCE CONTEXT (DAILY SUMMARY STATE)
      //
      // ‚ùó Backend-only writes
      // ----------------------------------------------------------
      match /intelligenceContext/{dateId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;
      }

      // ----------------------------------------------------------
      // DAY TRUTH (IMMUTABLE DAILY SNAPSHOT + REVISIONS)
      //
      // Phase 1: Historical replay anchor.
      //
      // ‚ùó CRITICAL INVARIANT:
      // - Clients may READ their dayTruth snapshots
      // - Clients may NEVER write
      // - Revisions are also read-only to clients
      // ----------------------------------------------------------
      match /dayTruth/{dateId} {
        allow read: if request.auth != null
                    && request.auth.uid == userId;
        allow create, update, delete: if false;

        match /revisions/{revisionId} {
          allow read: if request.auth != null
                      && request.auth.uid == userId;
          allow create, update, delete: if false;
        }
      }
    }
  }
}
