# Supply-Chain Vulnerability Policy

**Scope:** Oli Health OS — Phase 2 lock hardening and ongoing hygiene.  
**Authority:** This document describes what is enforced, what is monitored, and how exceptions are recorded.

---

## What Is Enforced

- **Production dependencies only:** `npm audit --omit=dev` (production tree only).
- **Threshold:** CI fails when there is at least one **HIGH** or **CRITICAL** vulnerability in production dependencies that is **not** covered by a valid, non-expired entry in the exceptions file.
- **Time-boxed exceptions:** Findings may be allowed only via `docs/90_audits/supply-chain-exceptions.json`. Every exception **must** include `expiresOn` (YYYY-MM-DD). Expired or missing-expiry entries are not valid.
- **Script:** `scripts/ci/audit-production.sh` (and `scripts/ci/audit-production.mjs`) — runs the audit, compares findings to exceptions, exits 0 only when clean or when all HIGH/CRITICAL are covered by non-expired exceptions (then prints an AUDIT WARN).

---

## What Is Monitored

- **Enforced:** HIGH and CRITICAL in production deps (blocking unless excepted with a future `expiresOn`).
- **Monitored / non-blocking:** LOW and MODERATE in production deps; any severity in devDependencies. These may be reported in CI as informational or in a separate non-blocking step.

---

## Exceptions Mechanism (Time-Boxed, Auditable)

- **File:** `docs/90_audits/supply-chain-exceptions.json` (machine-readable).
- **Schema:** One object per exception; all fields below are required unless noted.

  | Field       | Required | Description |
  |------------|----------|-------------|
  | `package`  | Yes      | npm package name (as in audit report). |
  | `advisoryId` | No     | Advisory id (e.g. `GHSA-34x7-hfp2-rc4v`). If present, matching is by package + severity + advisoryId; if omitted, by package + severity. |
  | `severity` | Yes      | `high` or `critical`. |
  | `reason`   | Yes      | Short justification (e.g. "Blocked by upstream; tracked in GH-123"). |
  | `owner`    | Yes      | Team or person responsible for remediation or renewal. |
  | `expiresOn`| Yes      | Date in YYYY-MM-DD. **Required.** After this date the exception no longer applies and the audit will fail until the finding is fixed or the exception is updated. |

- **Expiry:** Exceptions with `expiresOn` in the past are rejected. Exceptions missing `expiresOn` are rejected. This keeps every exception time-boxed and auditable.
- **How to add an exception:** Add an object to the `exceptions` array in `supply-chain-exceptions.json`. Run `bash scripts/ci/audit-production.sh` to confirm the finding is covered. Commit the change with a short note in the PR (reason + owner + expiry).
- **How to remove an exception:** Remove the object from the `exceptions` array (or fix the underlying vulnerability and then remove). Ensure the audit passes after the change.
- **Review expectation:** Exceptions should be reviewed in PRs. Before `expiresOn`, the owner should either fix the vulnerability (and remove the exception) or extend the date with a new justification.

---

## Running the Audit

- **Local (enforced):**  
  `bash scripts/ci/audit-production.sh`  
  Exits 0 if no HIGH/CRITICAL or if all are covered by valid exceptions (then prints AUDIT WARN). Exits 1 otherwise.
- **Report-only (non-blocking):**  
  `REPORT_ONLY=1 bash scripts/ci/audit-production.sh`  
  Prints findings and exception coverage; always exits 0. Use in CI for visibility without failing the build.
- **CI:** Add a job that runs `scripts/ci/audit-production.sh`; optional for Phase 2 gate, recommended for main/PR pipelines.

---

## Phase 2 Lock

The Phase 2 proof gate does **not** currently run the production audit. The audit is available as a separate CI step or local check. To make the proof gate block on HIGH+ production vulns, add a call to `scripts/ci/audit-production.sh` in `scripts/ci/proof-gate-phase2.sh` or in your CI workflow.

---

## References

- `scripts/ci/audit-production.sh` — entry point; calls `scripts/ci/audit-production.mjs`
- `scripts/ci/audit-production.mjs` — runs `npm audit --omit=dev --json`, applies exceptions, enforces expiry
- `docs/90_audits/supply-chain-exceptions.json` — machine-readable exceptions (expiresOn required)
- `docs/90_audits/INVARIANT_ENFORCEMENT_MAP.md` — overall invariant and check mapping
- Phase 2 addendum: `docs/00_truth/phase2/` — Phase 2 scope and lock criteria
