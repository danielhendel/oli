name: Cloud Run Deploy
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'cloudrun/**'
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GOOGLE_PROJECT_ID: ${{ secrets.GOOGLE_PROJECT_ID }}
      GOOGLE_REGION: ${{ secrets.GOOGLE_REGION }}
      SERVICE_NAME: oli-cloudrun
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - run: |
          cd cloudrun
          gcloud builds submit --tag gcr.io/$GOOGLE_PROJECT_ID/$SERVICE_NAME
          gcloud run deploy $SERVICE_NAME \
            --image gcr.io/$GOOGLE_PROJECT_ID/$SERVICE_NAME \
            --platform managed \
            --region $GOOGLE_REGION \
            --allow-unauthenticated \
            --update-env-vars BACKEND_BASE_URL=${{ secrets.BACKEND_BASE_URL }},FRONTEND_REDIRECT=${{ secrets.FRONTEND_REDIRECT }},JWT_STATE_SECRET=${{ secrets.JWT_STATE_SECRET }},OURA_CLIENT_ID=${{ secrets.OURA_CLIENT_ID }},OURA_CLIENT_SECRET=${{ secrets.OURA_CLIENT_SECRET }},WITHINGS_CLIENT_ID=${{ secrets.WITHINGS_CLIENT_ID }},WITHINGS_CLIENT_SECRET=${{ secrets.WITHINGS_CLIENT_SECRET }}
